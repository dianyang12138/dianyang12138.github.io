<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="后端Java工程师"><title>ElasticSearch笔记 | dian的博客</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 4.2.1"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">ElasticSearch笔记</h1><a id="logo" href="/.">dian的博客</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">ElasticSearch笔记</h1><div class="post-meta">2019-11-10</div><div class="post-content"><a id="more"></a>

<h2 id="es简介"><a href="#es简介" class="headerlink" title="es简介"></a>es简介</h2><p><a href="https://www.elastic.co/cn/products/elasticsearch" target="_blank" rel="noopener">Elasticsearch</a>是一个基于<a href="https://lucene.apache.org/core/" target="_blank" rel="noopener">Apache Lucene(TM)</a>的开源搜索引擎</p>
<p><a href="https://github.com/elastic/elasticsearch" target="_blank" rel="noopener">github</a></p>
<!--more-->

<h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><h4 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h4><ul>
<li><p>分布式的实时文件存储，每个字段都被索引并可被搜索</p>
</li>
<li><p>分布式的实时分析搜索引擎–做不规则查询</p>
</li>
<li><p>可以扩展到上百台服务器，处理PB级结构化或非结构化数据</p>
</li>
</ul>
<h4 id="用处"><a href="#用处" class="headerlink" title="用处"></a>用处</h4><p>全文检索（全部字段）、模糊查询（搜索）、数据分析（提供分析语法，例如聚合）</p>
<h4 id="同类比较"><a href="#同类比较" class="headerlink" title="同类比较"></a>同类比较</h4><p>Solr、ElasticSearch、Hermes（腾讯）（实时检索分析）</p>
<p>Solr、ES：侧重搜索与全文检索。数据规模从几百万到千万不等，数据量过亿的集群特别少</p>
<p>Hermes：侧重数据分析。数据规模从几亿到万亿不等。最小的表也是千万级别。</p>
<p>Solr、ES区别：</p>
<ul>
<li><p>Solr 利用 Zookeeper 进行分布式管理，而 Elasticsearch 自身带有分布式协调管理功能;</p>
</li>
<li><p>Solr 支持更多格式的数据，而 Elasticsearch 仅支持json文件格式；</p>
</li>
<li><p>Solr 官方提供的功能更多，而 Elasticsearch 本身更注重于核心功能，高级功能多有第三方插件提供；</p>
</li>
<li><p>Solr 在传统的搜索应用中表现好于 Elasticsearch，但在处理实时搜索应用时效率明显低于 Elasticsearch—–附近的人</p>
</li>
</ul>
<h3 id="es、ki安装"><a href="#es、ki安装" class="headerlink" title="es、ki安装"></a>es、ki安装</h3><h4 id="准备环境"><a href="#准备环境" class="headerlink" title="准备环境"></a>准备环境</h4><p>安装Centos7、建议内存2G以上、安装java1.8环境</p>
<blockquote>
<p>Centos6需要改动的配置较多</p>
</blockquote>
<h4 id="正式安装"><a href="#正式安装" class="headerlink" title="正式安装"></a>正式安装</h4><ul>
<li><p>拷贝并解压</p>
<ul>
<li>elasticsearch-6.6.0.tar.gz</li>
<li>kibana-6.6.0-linux-x86_64.tar.gz</li>
</ul>
</li>
<li><p>修改配置文件</p>
<ul>
<li>vim /bigdata/elasticsearch-6.6.0/config/elasticsearch.yml</li>
<li>集群名称，同一集群名称必须相同</li>
</ul>
<p><img src="/2019/11/10/ElasticSearch%E7%AC%94%E8%AE%B0/esinstall1.png" alt></p>
<ul>
<li>单个节点名称  ，同一集群中的节点，节点名必须不同</li>
</ul>
<p><img src="/2019/11/10/ElasticSearch%E7%AC%94%E8%AE%B0/esinstall2.png" alt></p>
<ul>
<li>网络部分  改为当前的ip地址  ，端口号保持默认9200就行</li>
</ul>
<p><img src="/2019/11/10/ElasticSearch%E7%AC%94%E8%AE%B0/esinstall3.png" alt></p>
<ul>
<li>把bootstrap自检程序关掉</li>
</ul>
<p><img src="/2019/11/10/ElasticSearch%E7%AC%94%E8%AE%B0/esinstall4.png" alt></p>
<ul>
<li>自发现配置：新节点向集群报到的主机名</li>
</ul>
<p><img src="/2019/11/10/ElasticSearch%E7%AC%94%E8%AE%B0/esinstall5.png" alt></p>
</li>
<li><p>修改Linux配置</p>
<ul>
<li><p>vi /etc/security/limits.conf</p>
<ul>
<li>添加内容：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">* soft nofile 65536</span><br><span class="line">* hard nofile 131072</span><br><span class="line">* soft nproc 2048</span><br><span class="line">* hard nproc 65536</span><br></pre></td></tr></table></figure>

</li>
</ul>
<blockquote>
<p>注意：“*” 不要省略掉</p>
</blockquote>
</li>
<li><p>vi /etc/security/limits.d/90-nproc.conf  （CentOS7.x  不用改）</p>
<ul>
<li><pre><code>修改如下内容：
* soft nproc 1024
#修改为
 * soft nproc 4096
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">-  vim  &#x2F;etc&#x2F;sysctl.conf文件最后添加一行（CentOS7.x  不用改）</span><br><span class="line"></span><br><span class="line">  -</span><br></pre></td></tr></table></figure>
vm.max_map_count=262144
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 修改虚拟机内存，防止es跑不动</span><br><span class="line"></span><br><span class="line">  ![](ElasticSearch笔记&#x2F;esinstall6.png)</span><br><span class="line"></span><br><span class="line">#### 配置ki</span><br><span class="line"></span><br><span class="line">- 进入kibana根目录的config下</span><br><span class="line"></span><br><span class="line">- vim  kibana.yml</span><br><span class="line"></span><br><span class="line">  ![](ElasticSearch笔记&#x2F;kibanainstall.png)</span><br><span class="line"></span><br><span class="line">&gt; 这里我的elasticsearch.url是没有的，改成这个启动会报错。将elasticsearch.url改成elasticsearch.host即可</span><br><span class="line"></span><br><span class="line">#### 群起脚本</span><br><span class="line"></span><br><span class="line">&#96;&#96;&#96;shell</span><br><span class="line">#!&#x2F;bin&#x2F;bash </span><br><span class="line">es_home&#x3D;es的根目录</span><br><span class="line">kibana_home&#x3D;kib的根目录</span><br><span class="line">case $1  in</span><br><span class="line"> &quot;start&quot;) &#123;</span><br><span class="line">  for i in 集群的ip</span><br><span class="line">  do</span><br><span class="line">    ssh $i  &quot;source &#x2F;etc&#x2F;profile;$&#123;es_home&#125;&#x2F;bin&#x2F;elasticsearch &gt;&#x2F;dev&#x2F;null 2&gt;&amp;1 &amp;&quot;</span><br><span class="line"> </span><br><span class="line">   done</span><br><span class="line">   nohup $&#123;kibana_home&#125;&#x2F;bin&#x2F;kibana &gt;kibana.log 2&gt;&amp;1 &amp;</span><br><span class="line">&#125;;;</span><br><span class="line">&quot;stop&quot;) &#123;</span><br><span class="line">  ps -ef|grep $&#123;kibana_home&#125; |grep -v grep|awk &#39;&#123;print $2&#125;&#39;|xargs kill</span><br><span class="line">  for i in 集群的ip</span><br><span class="line">  do</span><br><span class="line">      ssh $i &quot;ps -ef|grep $es_home |grep -v grep|awk &#39;&#123;print \$2&#125;&#39;|xargs kill&quot; &gt;&#x2F;dev&#x2F;null 2&gt;&amp;1</span><br><span class="line">  done</span><br><span class="line">  </span><br><span class="line">&#125;;;</span><br><span class="line">esac</span><br></pre></td></tr></table></figure>
</code></pre></li>
</ul>
</li>
</ul>
<h4 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h4><p><code>curl http://hadoop1:9200/_cat/nodes?v</code>出现对应机器的ip即可</p>
<h4 id="访问"><a href="#访问" class="headerlink" title="访问"></a>访问</h4><p>IP地址:</p>
<h2 id="Elasticsearch数据存储方式"><a href="#Elasticsearch数据存储方式" class="headerlink" title="Elasticsearch数据存储方式"></a>Elasticsearch数据存储方式</h2><h3 id="Elasticsearch存储方式"><a href="#Elasticsearch存储方式" class="headerlink" title="Elasticsearch存储方式"></a>Elasticsearch存储方式</h3><ul>
<li>面向文档</li>
</ul>
<p>Elasticsearch是面向文档(document oriented)的，这意味着它可以存储整个对象或文档(document)。然而它不仅仅是存储，还会索引(index)每个文档的内容使之可以被搜索。在Elasticsearch中，你可以对文档（而非成行成列的数据）进行索引、搜索、排序、过滤。这种理解数据的方式与以往完全不同，这也是Elasticsearch能够执行复杂的全文搜索的原因之一。</p>
<ul>
<li>JSON</li>
</ul>
<p>ELasticsearch使用Javascript对象符号(JavaScript Object Notation)，也就是<strong>JSON</strong>，作为文档序列化格式。JSON现在已经被大多语言所支持，而且已经成为NoSQL领域的标准格式。它简洁、简单且容易阅读。</p>
<h3 id="Elasticsearch存储结构"><a href="#Elasticsearch存储结构" class="headerlink" title="Elasticsearch存储结构"></a>Elasticsearch存储结构</h3><p><img src="/2019/11/10/ElasticSearch%E7%AC%94%E8%AE%B0/es_consistion.png" alt></p>
<blockquote>
<p>6.x一个index只有一个type</p>
</blockquote>
<h2 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h2><h3 id="创建索引库"><a href="#创建索引库" class="headerlink" title="创建索引库"></a>创建索引库</h3><p>settings和index是固定的</p>
<p>number_of_shards：分片数</p>
<p>number_of_replicas：副本数</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">put /索引库名称</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"settings"</span>:&#123;</span><br><span class="line">        <span class="attr">"index"</span>:&#123;</span><br><span class="line">            <span class="attr">"number_of_shards"</span>:<span class="number">1</span>,</span><br><span class="line">            <span class="attr">"number_of_replicas"</span>:<span class="number">0</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>相当于一张表</p>
</blockquote>
<h3 id="创建映射"><a href="#创建映射" class="headerlink" title="创建映射"></a>创建映射</h3><p>文档–Row记录</p>
<p>字段–Columns列</p>
<p>post <a href="http://localhost:9200/索引库名称/类型名称/_mapping" target="_blank" rel="noopener">http://localhost:9200/索引库名称/类型名称/_mapping</a> </p>
<blockquote>
<p>类型在6.0开始逐渐弱化，索引指定类型名称的时候，可以取一个没有意义的名字</p>
</blockquote>
<p>创建映射</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">POST 索引库名/类型名称/_mapping</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"properties"</span>: &#123;</span><br><span class="line">        <span class="attr">"name"</span>: &#123;</span><br><span class="line">            <span class="attr">"type"</span>: <span class="string">"text"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"description"</span>: &#123;</span><br><span class="line">            <span class="attr">"type"</span>: <span class="string">"text"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"studymodel"</span>: &#123;</span><br><span class="line">            <span class="attr">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"># 查看</span><br><span class="line">GET 索引库名/类型名称/[Id值]</span><br></pre></td></tr></table></figure>

<h3 id="创建文档"><a href="#创建文档" class="headerlink" title="创建文档"></a>创建文档</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST 索引库名/类型名称/[Id值]</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"字段名"</span>: <span class="string">"值"</span>,</span><br><span class="line">    <span class="attr">"字段名"</span>: <span class="string">"值"</span>,</span><br><span class="line">    ……</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果不指定Id值，会随机生成Id。修改既是覆盖</p>
<h3 id="搜索文档"><a href="#搜索文档" class="headerlink" title="搜索文档"></a>搜索文档</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#根据ID查询</span><br><span class="line">GET 索引库名/类型名称/[Id值]</span><br><span class="line"></span><br><span class="line">#结果</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"_index"</span> : <span class="string">"索引库名"</span>,</span><br><span class="line">  <span class="attr">"_type"</span> : <span class="string">"类型名称"</span>,</span><br><span class="line">  <span class="attr">"_id"</span> : <span class="string">"Id值"</span>,</span><br><span class="line">  <span class="attr">"_version"</span> : <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"_seq_no"</span> : <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"_primary_term"</span> : <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"found"</span> : <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"_source"</span> : &#123;</span><br><span class="line">    内容键值对</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="通过搜索接口搜索"><a href="#通过搜索接口搜索" class="headerlink" title="通过搜索接口搜索"></a>通过搜索接口搜索</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#查询所有</span><br><span class="line">GET 索引库名/类型名称/_search </span><br><span class="line"></span><br><span class="line">#查询name中包括xxx关键字的的记录，中文会报错</span><br><span class="line">GET 索引库名/类型名称/_search?q=name:xxx</span><br></pre></td></tr></table></figure>

<h3 id="删除文档"><a href="#删除文档" class="headerlink" title="删除文档"></a>删除文档</h3><p><code>DELETE /{index}/{type}/{id}</code>：根据id删除</p>
<p><code>POST /{index}/{type}/_delete_by_query</code>：通过搜索删除</p>
<h2 id="IK分词器"><a href="#IK分词器" class="headerlink" title="IK分词器"></a>IK分词器</h2><p>在添加文档时会进行分词，索引中存放的就是一个一个的词（term），当你去搜索时就是拿关键字去匹配词，最终找到词关联的文档。<br>测试当前索引库使用的分词器：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST _analyze</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"text"</span>:<span class="string">"测试分词器，后边是测试内容：spring cloud实战"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>发现是按照一个字一个字分词</p>
<h3 id="下载安装"><a href="#下载安装" class="headerlink" title="下载安装"></a>下载安装</h3><p><a href="https://github.com/medcl/elasticsearch-analysis-ik" target="_blank" rel="noopener">下载IK分词器</a>，在releases下载和es版本相同的ik分词器。解压将整个文件夹放入plugins文件夹下。文件夹名可以随意。重启es</p>
<p>测试ik分词器</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST _analyze</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"text"</span>:<span class="string">"测试分词器，后边是测试内容：spring cloud实战"</span>,</span><br><span class="line">    <span class="attr">"analyzer"</span>:<span class="string">"ik_max_word"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="俩种分词器"><a href="#俩种分词器" class="headerlink" title="俩种分词器"></a>俩种分词器</h3><p>ik分词器有两种分词模式：<code>ik_max_word</code>和<code>ik_smart</code>模式。</p>
<ol>
<li>ik_max_word<br>会将文本做最细粒度的拆分，比如会将“中华人民共和国人民大会堂”拆分为“中华人民共和国、中华人民、中华、华人、人民共和国、人民、共和国、大会堂、大会、会堂等词语。</li>
<li>ik_smart<br>会做最粗粒度的拆分，比如会将“中华人民共和国人民大会堂”拆分为中华人民共和国、人民大会堂。 </li>
</ol>
<h3 id="添加分词"><a href="#添加分词" class="headerlink" title="添加分词"></a>添加分词</h3><p>Ik分词器中有一些特殊词 是无法分词的，这就需要到<code>elasticsearch-6.6.0/plugins/analysis-ik/config/IKAnalyzer.cfg.xml</code>配置文件中指定要添加的词汇表</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">properties</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">"http://java.sun.com/dtd/properties.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">comment</span>&gt;</span>IK Analyzer 扩展配置<span class="tag">&lt;/<span class="name">comment</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--用户可以在这里配置自己的扩展字典 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"ext_dict"</span>&gt;</span>my.dic<span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">	 <span class="comment">&lt;!--用户可以在这里配置自己的扩展停止词字典--&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"ext_stopwords"</span>&gt;</span><span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--用户可以在这里配置远程扩展字典 --&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- &lt;entry key="remote_ext_dict"&gt;words_location&lt;/entry&gt; --&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--用户可以在这里配置远程扩展停止词字典--&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- &lt;entry key="remote_ext_stopwords"&gt;words_location&lt;/entry&gt; --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后在平级目录下创建my.dic</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">xxx</span><br><span class="line">xx</span><br></pre></td></tr></table></figure>

<blockquote>
<p>保存格式为UTF-8</p>
</blockquote>
<h2 id="映射"><a href="#映射" class="headerlink" title="映射"></a>映射</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#查看所有映射</span><br><span class="line">GET  _mapping</span><br><span class="line"></span><br><span class="line">#创建映射</span><br><span class="line">POST 索引库名/类型名称/_mapping</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"properties"</span>: &#123;</span><br><span class="line">        <span class="attr">"字段名"</span>: &#123;</span><br><span class="line">            <span class="attr">"type"</span>: <span class="string">"类型"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        ……</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#删除</span><br><span class="line">DELETE 索引库名</span><br></pre></td></tr></table></figure>

<blockquote>
<p>无则添加，有则更新。不允许已添加字段名的类型</p>
</blockquote>
<h3 id="常用映射类型"><a href="#常用映射类型" class="headerlink" title="常用映射类型"></a>常用映射类型</h3><ol>
<li><p>text：可以指定分词器和搜索时使用的分词器</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">"name": &#123;</span><br><span class="line">    "type": "text",</span><br><span class="line">    "analyzer":"ik_max_word",</span><br><span class="line">    "search_analyzer":"ik_smart",</span><br><span class="line">    #是否建立索引</span><br><span class="line">    "index":false,</span><br><span class="line">    #是否在source之外存储，每个文档索引后会在 ES中保存一份原始文档，存放在"_source"中，一般情况下不需要设置 store为true，因为在_source中已经有一份原始文档了。</span><br><span class="line">    "stoure": true</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="2">
<li><p>date类型：format设置样式</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">"timestamp": &#123;</span><br><span class="line">    "type": "date",</span><br><span class="line">    "format": "yyyy‐MM‐dd HH:mm:ss||yyyy‐MM‐dd"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="3">
<li><p>数值类型：尽量选择范围小的类型，提高搜索效率 .对于浮点数尽量用比例因子 </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">"price": &#123;</span><br><span class="line">    "type": "scaled_float",</span><br><span class="line">    "scaling_factor": 100</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ol>
<p>   <img src="/2019/11/10/ElasticSearch%E7%AC%94%E8%AE%B0/number_var.png" alt></p>
<h2 id="客户端维护索引"><a href="#客户端维护索引" class="headerlink" title="客户端维护索引"></a>客户端维护索引</h2><p>多种客户端</p>
<ol>
<li>TransportClient：计划8.0删除</li>
<li>RestClient：推荐使用包含俩种客户端 Java Low Level REST Client和 Java High Level REST Client。 两种客户端官方更推荐使用 Java High Level REST Client </li>
</ol>
<p>pom文件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch.client<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch‐rest‐high‐level‐client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//默认已经注入</span></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">RestHighLevelClient client;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">RestClient restClient;</span><br></pre></td></tr></table></figure>

<p>删除 索引库</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDeleteIndex</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">//删除索引对象</span></span><br><span class="line">    DeleteIndexRequest deleteIndexRequest = <span class="keyword">new</span> DeleteIndexRequest(<span class="string">"xc_course"</span>);</span><br><span class="line">    <span class="comment">//操作索引的客户端</span></span><br><span class="line">    IndicesClient indices = client.indices();</span><br><span class="line">    <span class="comment">//执行删除索引</span></span><br><span class="line">    DeleteIndexResponse delete = indices.delete(deleteIndexRequest);</span><br><span class="line">    <span class="comment">//得到响应</span></span><br><span class="line">    <span class="keyword">boolean</span> acknowledged = delete.isAcknowledged();</span><br><span class="line">    System.out.println(acknowledged);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建索引库</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testCreateIndex</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">//创建索引对象</span></span><br><span class="line">    CreateIndexRequest createIndexRequest = <span class="keyword">new</span> CreateIndexRequest(<span class="string">"xc_course"</span>);</span><br><span class="line">    <span class="comment">//设置参数</span></span><br><span class="line">    createIndexRequest.settings(Settings.builder().put(<span class="string">"number_of_shards"</span>, <span class="string">"1"</span>).put(<span class="string">"number_of_replicas"</span>, <span class="string">"0"</span>));</span><br><span class="line">    <span class="comment">//指定映射</span></span><br><span class="line">    createIndexRequest.mapping(<span class="string">"doc"</span>, <span class="string">" &#123;\n"</span> +</span><br><span class="line">                               <span class="string">" \t\"properties\": &#123;\n"</span> +</span><br><span class="line">                               <span class="string">"            \"studymodel\":&#123;\n"</span> +</span><br><span class="line">                               <span class="string">"             \"type\":\"keyword\"\n"</span> +</span><br><span class="line">                               <span class="string">"           &#125;,\n"</span> +</span><br><span class="line">                               <span class="string">"            \"name\":&#123;\n"</span> +</span><br><span class="line">                               <span class="string">"             \"type\":\"keyword\"\n"</span> +</span><br><span class="line">                               <span class="string">"           &#125;,\n"</span> +</span><br><span class="line">                               <span class="string">"           \"description\": &#123;\n"</span> +</span><br><span class="line">                               <span class="string">"              \"type\": \"text\",\n"</span> +</span><br><span class="line">                               <span class="string">"              \"analyzer\":\"ik_max_word\",\n"</span> +</span><br><span class="line">                               <span class="string">"              \"search_analyzer\":\"ik_smart\"\n"</span> +</span><br><span class="line">                               <span class="string">"           &#125;,\n"</span> +</span><br><span class="line">                               <span class="string">"           \"pic\":&#123;\n"</span> +</span><br><span class="line">                               <span class="string">"             \"type\":\"text\",\n"</span> +</span><br><span class="line">                               <span class="string">"             \"index\":false\n"</span> +</span><br><span class="line">                               <span class="string">"           &#125;\n"</span> +</span><br><span class="line">                               <span class="string">" \t&#125;\n"</span> +</span><br><span class="line">                               <span class="string">"&#125;"</span>, XContentType.JSON);</span><br><span class="line">    <span class="comment">//操作索引的客户端</span></span><br><span class="line">    IndicesClient indices = client.indices();</span><br><span class="line">    <span class="comment">//执行创建索引库</span></span><br><span class="line">    CreateIndexResponse createIndexResponse = indices.create(createIndexRequest);</span><br><span class="line">    <span class="comment">//得到响应</span></span><br><span class="line">    <span class="keyword">boolean</span> acknowledged = createIndexResponse.isAcknowledged();</span><br><span class="line">    System.out.println(acknowledged);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>添加文档</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//添加文档</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testAddDoc</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">//准备json数据</span></span><br><span class="line">    Map&lt;String, Object&gt; jsonMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    jsonMap.put(<span class="string">"name"</span>, <span class="string">"spring cloud实战"</span>);</span><br><span class="line">    jsonMap.put(<span class="string">"description"</span>, <span class="string">"本课程主要从四个章节进行讲解： 1.微服务架构入门 2.spring cloud基础入门 3.实战Spring Boot 4.注册中心eureka。"</span>);</span><br><span class="line">    jsonMap.put(<span class="string">"studymodel"</span>, <span class="string">"201001"</span>);</span><br><span class="line">    SimpleDateFormat dateFormat =<span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy‐MM‐dd HH:mm:ss"</span>);</span><br><span class="line">    jsonMap.put(<span class="string">"timestamp"</span>, dateFormat.format(<span class="keyword">new</span> Date()));</span><br><span class="line">    jsonMap.put(<span class="string">"price"</span>, <span class="number">5.6f</span>);</span><br><span class="line">    <span class="comment">//索引请求对象</span></span><br><span class="line">    IndexRequest indexRequest = <span class="keyword">new</span> IndexRequest(<span class="string">"xc_course"</span>,<span class="string">"doc"</span>);</span><br><span class="line">    <span class="comment">//指定索引文档内容</span></span><br><span class="line">    indexRequest.source(jsonMap);</span><br><span class="line">    <span class="comment">//索引响应对象</span></span><br><span class="line">    IndexResponse indexResponse = client.index(indexRequest);</span><br><span class="line">    <span class="comment">//获取响应结果</span></span><br><span class="line">    DocWriteResponse.Result result = indexResponse.getResult();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查询文档</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getDoc</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    GetRequest getRequest = <span class="keyword">new</span> GetRequest(</span><br><span class="line">        <span class="string">"xc_course"</span>,</span><br><span class="line">        <span class="string">"doc"</span>,</span><br><span class="line">        <span class="string">"4028e581617f945f01617f9dabc40000"</span>);</span><br><span class="line">    GetResponse getResponse = client.get(getRequest);</span><br><span class="line">    <span class="keyword">boolean</span> exists = getResponse.isExists();</span><br><span class="line">    Map&lt;String, Object&gt; sourceAsMap = getResponse.getSourceAsMap();</span><br><span class="line">    System.out.println(sourceAsMap);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>更新文档</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//更新文档</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateDoc</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    UpdateRequest updateRequest = <span class="keyword">new</span> UpdateRequest(<span class="string">"xc_course"</span>, <span class="string">"doc"</span>,<span class="string">"4028e581617f945f01617f9dabc40000"</span>);</span><br><span class="line">    Map&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    map.put(<span class="string">"name"</span>, <span class="string">"spring cloud实战"</span>);</span><br><span class="line">    updateRequest.doc(map);</span><br><span class="line">    UpdateResponse update = client.update(updateRequest);</span><br><span class="line">    RestStatus status = update.status();</span><br><span class="line">    System.out.println(status);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>删除文档</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//根据id删除文档</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDelDoc</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">//删除文档id</span></span><br><span class="line">    String id = <span class="string">"eqP_amQBKsGOdwJ4fHiC"</span>;</span><br><span class="line">    <span class="comment">//删除索引请求对象</span></span><br><span class="line">    DeleteRequest deleteRequest = <span class="keyword">new</span> DeleteRequest(<span class="string">"xc_course"</span>,<span class="string">"doc"</span>,id);</span><br><span class="line">    <span class="comment">//响应对象</span></span><br><span class="line">    DeleteResponse deleteResponse = client.delete(deleteRequest);</span><br><span class="line">    <span class="comment">//获取响应结果</span></span><br><span class="line">    DocWriteResponse.Result result = deleteResponse.getResult();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="搜索"><a href="#搜索" class="headerlink" title="搜索"></a>搜索</h2><h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">PUT /xc_course</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"settings"</span>:&#123;</span><br><span class="line">        <span class="attr">"index"</span>:&#123;</span><br><span class="line">            <span class="attr">"number_of_shards"</span>:<span class="number">1</span>,</span><br><span class="line">            <span class="attr">"number_of_replicas"</span>:<span class="number">0</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST xc_course/doc/_mapping</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"properties"</span>: &#123;</span><br><span class="line">        <span class="attr">"description"</span>: &#123;</span><br><span class="line">            <span class="attr">"type"</span>: <span class="string">"text"</span>,</span><br><span class="line">            <span class="attr">"analyzer"</span>: <span class="string">"ik_max_word"</span>,</span><br><span class="line">            <span class="attr">"search_analyzer"</span>: <span class="string">"ik_smart"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"name"</span>: &#123;</span><br><span class="line">            <span class="attr">"type"</span>: <span class="string">"text"</span>,</span><br><span class="line">            <span class="attr">"analyzer"</span>: <span class="string">"ik_max_word"</span>,</span><br><span class="line">            <span class="attr">"search_analyzer"</span>: <span class="string">"ik_smart"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"pic"</span>:&#123;</span><br><span class="line">            <span class="attr">"type"</span>:<span class="string">"text"</span>,</span><br><span class="line">            <span class="attr">"index"</span>:<span class="literal">false</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"price"</span>: &#123;</span><br><span class="line">            <span class="attr">"type"</span>: <span class="string">"float"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"studymodel"</span>: &#123;</span><br><span class="line">            <span class="attr">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"timestamp"</span>: &#123;</span><br><span class="line">            <span class="attr">"type"</span>: <span class="string">"date"</span>,</span><br><span class="line">            <span class="attr">"format"</span>: <span class="string">"yyyy‐MM‐dd HH:mm:ss||yyyy‐MM‐dd||epoch_millis"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /xc_course/doc/1</span><br><span class="line">&#123; </span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"Bootstrap开发"</span>,</span><br><span class="line">    <span class="attr">"description"</span>: <span class="string">"Bootstrap是由Twitter推出的一个前台页面开发框架，是一个非常流行的开发框架，此框架集成了多种页面效果。此开发框架包含了大量的CSS、JS程序代码，可以帮助开发者（尤其是不擅长页面开发的程序人员）轻松的实现一个不受浏览器限制的精美界面效果。"</span>,</span><br><span class="line">    <span class="attr">"studymodel"</span>: <span class="string">"201002"</span>,</span><br><span class="line">    <span class="attr">"price"</span>:<span class="number">38.6</span>,</span><br><span class="line">    <span class="attr">"timestamp"</span>:<span class="string">"2018‐04‐25 19:11:35"</span>,</span><br><span class="line">    <span class="attr">"pic"</span>:<span class="string">"group1/M00/00/00/wKhlQFs6RCeAY0pHAAJx5ZjNDEM428.jpg"</span></span><br><span class="line">&#125; </span><br><span class="line">PUT xc_course/doc/2</span><br><span class="line">&#123; </span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"java编程基础"</span>,</span><br><span class="line">    <span class="attr">"description"</span>: <span class="string">"java语言是世界第一编程语言，在软件开发领域使用人数最多。"</span>,</span><br><span class="line">    <span class="attr">"studymodel"</span>: <span class="string">"201001"</span>,</span><br><span class="line">    <span class="attr">"price"</span>:<span class="number">68.6</span>,</span><br><span class="line">    <span class="attr">"timestamp"</span>:<span class="string">"2018‐03‐25 19:11:35"</span>,</span><br><span class="line">    <span class="attr">"pic"</span>:<span class="string">"group1/M00/00/00/wKhlQFs6RCeAY0pHAAJx5ZjNDEM428.jpg"</span></span><br><span class="line">&#125; </span><br><span class="line">PUT xc_course/doc/3</span><br><span class="line">&#123; </span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"spring开发基础"</span>,</span><br><span class="line">    <span class="attr">"description"</span>: <span class="string">"spring 在java领域非常流行，java程序员都在用。"</span>,</span><br><span class="line">    <span class="attr">"studymodel"</span>: <span class="string">"201001"</span>,</span><br><span class="line">    <span class="attr">"price"</span>:<span class="number">88.6</span>,</span><br><span class="line">    <span class="attr">"timestamp"</span>:<span class="string">"2018‐02‐24 19:11:35"</span>,</span><br><span class="line">    <span class="attr">"pic"</span>:<span class="string">"group1/M00/00/00/wKhlQFs6RCeAY0pHAAJx5ZjNDEM428.jpg"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="DSL搜索"><a href="#DSL搜索" class="headerlink" title="DSL搜索"></a>DSL搜索</h3><p>ES提出的基于JSON的搜索方式</p>
<h4 id="查询所有文档"><a href="#查询所有文档" class="headerlink" title="查询所有文档"></a>查询所有文档</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST xc_course/doc/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"query"</span>: &#123;</span><br><span class="line">        <span class="attr">"match_all"</span>: &#123;&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"_source"</span> : [<span class="string">"name"</span>,<span class="string">"studymodel"</span>,<span class="string">"description"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查询结果</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"took"</span> : <span class="number">5</span>,</span><br><span class="line">  <span class="attr">"timed_out"</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">"_shards"</span> : &#123;</span><br><span class="line">    <span class="attr">"total"</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"successful"</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"skipped"</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"failed"</span> : <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"hits"</span> : &#123;</span><br><span class="line">    <span class="attr">"total"</span> : <span class="number">3</span>,</span><br><span class="line">    <span class="attr">"max_score"</span> : <span class="number">1.0</span>,</span><br><span class="line">    <span class="attr">"hits"</span> : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"_index"</span> : <span class="string">"xc_course"</span>,</span><br><span class="line">        <span class="attr">"_type"</span> : <span class="string">"doc"</span>,</span><br><span class="line">        <span class="attr">"_id"</span> : <span class="string">"1"</span>,</span><br><span class="line">        <span class="attr">"_score"</span> : <span class="number">1.0</span>,</span><br><span class="line">        <span class="attr">"_source"</span> : &#123;</span><br><span class="line">          <span class="attr">"studymodel"</span> : <span class="string">"201002"</span>,</span><br><span class="line">          <span class="attr">"name"</span> : <span class="string">"Bootstrap开发"</span>,</span><br><span class="line">          <span class="attr">"description"</span> : <span class="string">"Bootstrap是由Twitter推出的一个前台页面开发框架，是一个非常流行的开发框架，此框架集成了多种页面效果。此开发框架包含了大量的CSS、JS程序代码，可以帮助开发者（尤其是不擅长页面开发的程序人员）轻松的实现一个不受浏览器限制的精美界面效果。"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"_index"</span> : <span class="string">"xc_course"</span>,</span><br><span class="line">        <span class="attr">"_type"</span> : <span class="string">"doc"</span>,</span><br><span class="line">        <span class="attr">"_id"</span> : <span class="string">"2"</span>,</span><br><span class="line">        <span class="attr">"_score"</span> : <span class="number">1.0</span>,</span><br><span class="line">        <span class="attr">"_source"</span> : &#123;</span><br><span class="line">          <span class="attr">"studymodel"</span> : <span class="string">"201001"</span>,</span><br><span class="line">          <span class="attr">"name"</span> : <span class="string">"java编程基础"</span>,</span><br><span class="line">          <span class="attr">"description"</span> : <span class="string">"java语言是世界第一编程语言，在软件开发领域使用人数最多。"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"_index"</span> : <span class="string">"xc_course"</span>,</span><br><span class="line">        <span class="attr">"_type"</span> : <span class="string">"doc"</span>,</span><br><span class="line">        <span class="attr">"_id"</span> : <span class="string">"3"</span>,</span><br><span class="line">        <span class="attr">"_score"</span> : <span class="number">1.0</span>,</span><br><span class="line">        <span class="attr">"_source"</span> : &#123;</span><br><span class="line">          <span class="attr">"studymodel"</span> : <span class="string">"201001"</span>,</span><br><span class="line">          <span class="attr">"name"</span> : <span class="string">"spring开发基础"</span>,</span><br><span class="line">          <span class="attr">"description"</span> : <span class="string">"spring 在java领域非常流行，java程序员都在用。"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>took：本次操作花费的时间，单位为毫秒。</li>
<li>timed_out：请求是否超时</li>
<li>_shards：说明本次操作共搜索了哪些分片</li>
<li>hits：搜索命中的记录</li>
<li>hits.total ： 符合条件的文档总数 hits.hits ：匹配度较高的前N个文档</li>
<li>hits.max_score：文档匹配得分，这里为最高分</li>
<li>_score：每个文档都有一个匹配度得分，按照降序排列。</li>
<li>_source：显示了文档的原始内容。 </li>
</ul>
<h5 id="JAVA-API"><a href="#JAVA-API" class="headerlink" title="JAVA API"></a>JAVA API</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@RunWith</span>(SpringRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">TestSearch</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RestHighLevelClient client;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RestClient restClient;</span><br><span class="line">    <span class="comment">//搜索全部记录</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSearchAll</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ParseException </span>&#123;</span><br><span class="line">        <span class="comment">//搜索请求对象</span></span><br><span class="line">        SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(<span class="string">"xc_course"</span>);</span><br><span class="line">        <span class="comment">//指定类型</span></span><br><span class="line">        searchRequest.types(<span class="string">"doc"</span>);</span><br><span class="line">        <span class="comment">//搜索源构建对象</span></span><br><span class="line">        SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">        <span class="comment">//搜索方式</span></span><br><span class="line">        <span class="comment">//matchAllQuery搜索全部</span></span><br><span class="line">        searchSourceBuilder.query(QueryBuilders.matchAllQuery());</span><br><span class="line">        <span class="comment">//设置源字段过虑,第一个参数结果集包括哪些字段，第二个参数表示结果集不包括哪些字段</span></span><br><span class="line">        searchSourceBuilder.fetchSource(<span class="keyword">new</span> String[]&#123;<span class="string">"name"</span>,<span class="string">"studymodel"</span>,<span class="string">"price"</span>,<span class="string">"timestamp"</span>&#125;,<span class="keyword">new</span> String[]&#123;&#125;);</span><br><span class="line">        <span class="comment">//向搜索请求对象中设置搜索源</span></span><br><span class="line">        searchRequest.source(searchSourceBuilder);</span><br><span class="line">        <span class="comment">//执行搜索,向ES发起http请求</span></span><br><span class="line">        SearchResponse searchResponse = client.search(searchRequest);</span><br><span class="line">        <span class="comment">//搜索结果</span></span><br><span class="line">        SearchHits hits = searchResponse.getHits();</span><br><span class="line">        <span class="comment">//匹配到的总记录数</span></span><br><span class="line">        <span class="keyword">long</span> totalHits = hits.getTotalHits();</span><br><span class="line">        <span class="comment">//得到匹配度高的文档</span></span><br><span class="line">        SearchHit[] searchHits = hits.getHits();</span><br><span class="line">        <span class="comment">//日期格式化对象</span></span><br><span class="line">        SimpleDateFormat dateFormat = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>);</span><br><span class="line">        <span class="keyword">for</span>(SearchHit hit:searchHits)&#123;</span><br><span class="line">            <span class="comment">//文档的主键</span></span><br><span class="line">            String id = hit.getId();</span><br><span class="line">            <span class="comment">//源文档内容</span></span><br><span class="line">            Map&lt;String, Object&gt; sourceAsMap = hit.getSourceAsMap();</span><br><span class="line">            String name = (String) sourceAsMap.get(<span class="string">"name"</span>);</span><br><span class="line">            <span class="comment">//由于前边设置了源文档字段过虑，这时description是取不到的</span></span><br><span class="line">            String description = (String) sourceAsMap.get(<span class="string">"description"</span>);</span><br><span class="line">            <span class="comment">//学习模式</span></span><br><span class="line">            String studymodel = (String) sourceAsMap.get(<span class="string">"studymodel"</span>);</span><br><span class="line">            <span class="comment">//价格</span></span><br><span class="line">            Double price = (Double) sourceAsMap.get(<span class="string">"price"</span>);</span><br><span class="line">            <span class="comment">//日期</span></span><br><span class="line">            Date timestamp = dateFormat.parse((String) sourceAsMap.get(<span class="string">"timestamp"</span>));</span><br><span class="line">            System.out.println(name);</span><br><span class="line">            System.out.println(studymodel);</span><br><span class="line">            System.out.println(description);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="分页查询"><a href="#分页查询" class="headerlink" title="分页查询"></a>分页查询</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">POST xc_course/doc/_search</span><br><span class="line">&#123; </span><br><span class="line">    <span class="attr">"from"</span> : <span class="number">0</span>, <span class="attr">"size"</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"query"</span>: &#123;</span><br><span class="line">        <span class="attr">"match_all"</span>: &#123;&#125;</span><br><span class="line">    &#125;,</span><br><span class="line"> <span class="attr">"_source"</span> : [<span class="string">"name"</span>,<span class="string">"studymodel"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>from：起始位置</li>
<li>size：条目数</li>
</ul>
<h5 id="JAVA-API-1"><a href="#JAVA-API-1" class="headerlink" title="JAVA API"></a>JAVA API</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//分页查询</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSearchPage</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ParseException </span>&#123;</span><br><span class="line">    <span class="comment">//搜索请求对象</span></span><br><span class="line">    SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(<span class="string">"xc_course"</span>);</span><br><span class="line">    <span class="comment">//指定类型</span></span><br><span class="line">    searchRequest.types(<span class="string">"doc"</span>);</span><br><span class="line">    <span class="comment">//搜索源构建对象</span></span><br><span class="line">    SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">    <span class="comment">//设置分页参数</span></span><br><span class="line">    <span class="comment">//页码</span></span><br><span class="line">    <span class="keyword">int</span> page = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">//每页记录数</span></span><br><span class="line">    <span class="keyword">int</span> size = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">//计算出记录起始下标</span></span><br><span class="line">    <span class="keyword">int</span> from  = (page-<span class="number">1</span>)*size;</span><br><span class="line">    searchSourceBuilder.from(from);<span class="comment">//起始记录下标，从0开始</span></span><br><span class="line">    searchSourceBuilder.size(size);<span class="comment">//每页显示的记录数</span></span><br><span class="line">    <span class="comment">//搜索方式</span></span><br><span class="line">    <span class="comment">//matchAllQuery搜索全部</span></span><br><span class="line">    searchSourceBuilder.query(QueryBuilders.matchAllQuery());</span><br><span class="line">    <span class="comment">//设置源字段过虑,第一个参数结果集包括哪些字段，第二个参数表示结果集不包括哪些字段</span></span><br><span class="line">    searchSourceBuilder.fetchSource(<span class="keyword">new</span> String[]&#123;<span class="string">"name"</span>,<span class="string">"studymodel"</span>,<span class="string">"price"</span>,<span class="string">"timestamp"</span>&#125;,<span class="keyword">new</span> String[]&#123;&#125;);</span><br><span class="line">    <span class="comment">//向搜索请求对象中设置搜索源</span></span><br><span class="line">    searchRequest.source(searchSourceBuilder);</span><br><span class="line">    <span class="comment">//执行搜索,向ES发起http请求</span></span><br><span class="line">    SearchResponse searchResponse = client.search(searchRequest);</span><br><span class="line">    <span class="comment">//搜索结果</span></span><br><span class="line">    SearchHits hits = searchResponse.getHits();</span><br><span class="line">    <span class="comment">//匹配到的总记录数</span></span><br><span class="line">    <span class="keyword">long</span> totalHits = hits.getTotalHits();</span><br><span class="line">    <span class="comment">//得到匹配度高的文档</span></span><br><span class="line">    SearchHit[] searchHits = hits.getHits();</span><br><span class="line">    <span class="comment">//日期格式化对象</span></span><br><span class="line">    SimpleDateFormat dateFormat = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>);</span><br><span class="line">    <span class="keyword">for</span>(SearchHit hit:searchHits)&#123;</span><br><span class="line">        <span class="comment">//文档的主键</span></span><br><span class="line">        String id = hit.getId();</span><br><span class="line">        <span class="comment">//源文档内容</span></span><br><span class="line">        Map&lt;String, Object&gt; sourceAsMap = hit.getSourceAsMap();</span><br><span class="line">        String name = (String) sourceAsMap.get(<span class="string">"name"</span>);</span><br><span class="line">        <span class="comment">//由于前边设置了源文档字段过虑，这时description是取不到的</span></span><br><span class="line">        String description = (String) sourceAsMap.get(<span class="string">"description"</span>);</span><br><span class="line">        <span class="comment">//学习模式</span></span><br><span class="line">        String studymodel = (String) sourceAsMap.get(<span class="string">"studymodel"</span>);</span><br><span class="line">        <span class="comment">//价格</span></span><br><span class="line">        Double price = (Double) sourceAsMap.get(<span class="string">"price"</span>);</span><br><span class="line">        <span class="comment">//日期</span></span><br><span class="line">        Date timestamp = dateFormat.parse((String) sourceAsMap.get(<span class="string">"timestamp"</span>));</span><br><span class="line">        System.out.println(name);</span><br><span class="line">        System.out.println(studymodel);</span><br><span class="line">        System.out.println(description);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>分页查询时，total数是匹配到的数，而不是查询结果数</p>
</blockquote>
<h4 id="Term-Query"><a href="#Term-Query" class="headerlink" title="Term Query"></a>Term Query</h4><p>Term Query为精确查询，在搜索时会整体匹配关键字，不再将关键字分词。 </p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">POST xc_course/doc/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"query"</span>: &#123;</span><br><span class="line">        <span class="attr">"term"</span> : &#123;</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"spring"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"_source"</span> : [<span class="string">"name"</span>,<span class="string">"studymodel"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这里是整体搜索，如果es分词了spring开发，为spring、开发。你搜索spring能匹配到，但是搜索spring开发就无法匹配到</p>
</blockquote>
<h5 id="JAVA-API-2"><a href="#JAVA-API-2" class="headerlink" title="JAVA API"></a>JAVA API</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//TermQuery</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testTermQuery</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ParseException </span>&#123;</span><br><span class="line">    <span class="comment">//搜索请求对象</span></span><br><span class="line">    SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(<span class="string">"xc_course"</span>);</span><br><span class="line">    <span class="comment">//指定类型</span></span><br><span class="line">    searchRequest.types(<span class="string">"doc"</span>);</span><br><span class="line">    <span class="comment">//搜索源构建对象</span></span><br><span class="line">    SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">    <span class="comment">//设置分页参数</span></span><br><span class="line">    <span class="comment">//页码</span></span><br><span class="line">    <span class="keyword">int</span> page = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">//每页记录数</span></span><br><span class="line">    <span class="keyword">int</span> size = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">//计算出记录起始下标</span></span><br><span class="line">    <span class="keyword">int</span> from  = (page-<span class="number">1</span>)*size;</span><br><span class="line">    searchSourceBuilder.from(from);<span class="comment">//起始记录下标，从0开始</span></span><br><span class="line">    searchSourceBuilder.size(size);<span class="comment">//每页显示的记录数</span></span><br><span class="line">    <span class="comment">//搜索方式</span></span><br><span class="line">    <span class="comment">//termQuery</span></span><br><span class="line">    searchSourceBuilder.query(QueryBuilders.termQuery(<span class="string">"name"</span>,<span class="string">"spring"</span>));</span><br><span class="line">    <span class="comment">//设置源字段过虑,第一个参数结果集包括哪些字段，第二个参数表示结果集不包括哪些字段</span></span><br><span class="line">    searchSourceBuilder.fetchSource(<span class="keyword">new</span> String[]&#123;<span class="string">"name"</span>,<span class="string">"studymodel"</span>,<span class="string">"price"</span>,<span class="string">"timestamp"</span>&#125;,<span class="keyword">new</span> String[]&#123;&#125;);</span><br><span class="line">    <span class="comment">//向搜索请求对象中设置搜索源</span></span><br><span class="line">    searchRequest.source(searchSourceBuilder);</span><br><span class="line">    <span class="comment">//执行搜索,向ES发起http请求</span></span><br><span class="line">    SearchResponse searchResponse = client.search(searchRequest);</span><br><span class="line">    <span class="comment">//搜索结果</span></span><br><span class="line">    SearchHits hits = searchResponse.getHits();</span><br><span class="line">    <span class="comment">//匹配到的总记录数</span></span><br><span class="line">    <span class="keyword">long</span> totalHits = hits.getTotalHits();</span><br><span class="line">    <span class="comment">//得到匹配度高的文档</span></span><br><span class="line">    SearchHit[] searchHits = hits.getHits();</span><br><span class="line">    <span class="comment">//日期格式化对象</span></span><br><span class="line">    SimpleDateFormat dateFormat = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>);</span><br><span class="line">    <span class="keyword">for</span>(SearchHit hit:searchHits)&#123;</span><br><span class="line">        <span class="comment">//文档的主键</span></span><br><span class="line">        String id = hit.getId();</span><br><span class="line">        <span class="comment">//源文档内容</span></span><br><span class="line">        Map&lt;String, Object&gt; sourceAsMap = hit.getSourceAsMap();</span><br><span class="line">        String name = (String) sourceAsMap.get(<span class="string">"name"</span>);</span><br><span class="line">        <span class="comment">//由于前边设置了源文档字段过虑，这时description是取不到的</span></span><br><span class="line">        String description = (String) sourceAsMap.get(<span class="string">"description"</span>);</span><br><span class="line">        <span class="comment">//学习模式</span></span><br><span class="line">        String studymodel = (String) sourceAsMap.get(<span class="string">"studymodel"</span>);</span><br><span class="line">        <span class="comment">//价格</span></span><br><span class="line">        Double price = (Double) sourceAsMap.get(<span class="string">"price"</span>);</span><br><span class="line">        <span class="comment">//日期</span></span><br><span class="line">        Date timestamp = dateFormat.parse((String) sourceAsMap.get(<span class="string">"timestamp"</span>));</span><br><span class="line">        System.out.println(name);</span><br><span class="line">        System.out.println(studymodel);</span><br><span class="line">        System.out.println(description);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="根据id精确匹配"><a href="#根据id精确匹配" class="headerlink" title="根据id精确匹配"></a>根据id精确匹配</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">POST xc_course/doc/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"query"</span>: &#123;</span><br><span class="line">        <span class="attr">"ids"</span> : &#123;</span><br><span class="line">            <span class="attr">"type"</span> : <span class="string">"doc"</span>,</span><br><span class="line">            <span class="attr">"values"</span> : [<span class="string">"3"</span>, <span class="string">"4"</span>, <span class="string">"100"</span>]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="JAVA-API-3"><a href="#JAVA-API-3" class="headerlink" title="JAVA API"></a>JAVA API</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//根据id查询</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testTermQueryByIds</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ParseException </span>&#123;</span><br><span class="line">    <span class="comment">//搜索请求对象</span></span><br><span class="line">    SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(<span class="string">"xc_course"</span>);</span><br><span class="line">    <span class="comment">//指定类型</span></span><br><span class="line">    searchRequest.types(<span class="string">"doc"</span>);</span><br><span class="line">    <span class="comment">//搜索源构建对象</span></span><br><span class="line">    SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">    <span class="comment">//搜索方式</span></span><br><span class="line">    <span class="comment">//根据id查询</span></span><br><span class="line">    <span class="comment">//定义id</span></span><br><span class="line">    String[] ids = <span class="keyword">new</span> String[]&#123;<span class="string">"1"</span>,<span class="string">"2"</span>&#125;;</span><br><span class="line">    searchSourceBuilder.query(QueryBuilders.termsQuery(<span class="string">"_id"</span>,ids));</span><br><span class="line">    <span class="comment">//设置源字段过虑,第一个参数结果集包括哪些字段，第二个参数表示结果集不包括哪些字段</span></span><br><span class="line">    searchSourceBuilder.fetchSource(<span class="keyword">new</span> String[]&#123;<span class="string">"name"</span>,<span class="string">"studymodel"</span>,<span class="string">"price"</span>,<span class="string">"timestamp"</span>&#125;,<span class="keyword">new</span> String[]&#123;&#125;);</span><br><span class="line">    <span class="comment">//向搜索请求对象中设置搜索源</span></span><br><span class="line">    searchRequest.source(searchSourceBuilder);</span><br><span class="line">    <span class="comment">//执行搜索,向ES发起http请求</span></span><br><span class="line">    SearchResponse searchResponse = client.search(searchRequest);</span><br><span class="line">    <span class="comment">//搜索结果</span></span><br><span class="line">    SearchHits hits = searchResponse.getHits();</span><br><span class="line">    <span class="comment">//匹配到的总记录数</span></span><br><span class="line">    <span class="keyword">long</span> totalHits = hits.getTotalHits();</span><br><span class="line">    <span class="comment">//得到匹配度高的文档</span></span><br><span class="line">    SearchHit[] searchHits = hits.getHits();</span><br><span class="line">    <span class="comment">//日期格式化对象</span></span><br><span class="line">    SimpleDateFormat dateFormat = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>);</span><br><span class="line">    <span class="keyword">for</span>(SearchHit hit:searchHits)&#123;</span><br><span class="line">        <span class="comment">//文档的主键</span></span><br><span class="line">        String id = hit.getId();</span><br><span class="line">        <span class="comment">//源文档内容</span></span><br><span class="line">        Map&lt;String, Object&gt; sourceAsMap = hit.getSourceAsMap();</span><br><span class="line">        String name = (String) sourceAsMap.get(<span class="string">"name"</span>);</span><br><span class="line">        <span class="comment">//由于前边设置了源文档字段过虑，这时description是取不到的</span></span><br><span class="line">        String description = (String) sourceAsMap.get(<span class="string">"description"</span>);</span><br><span class="line">        <span class="comment">//学习模式</span></span><br><span class="line">        String studymodel = (String) sourceAsMap.get(<span class="string">"studymodel"</span>);</span><br><span class="line">        <span class="comment">//价格</span></span><br><span class="line">        Double price = (Double) sourceAsMap.get(<span class="string">"price"</span>);</span><br><span class="line">        <span class="comment">//日期</span></span><br><span class="line">        Date timestamp = dateFormat.parse((String) sourceAsMap.get(<span class="string">"timestamp"</span>));</span><br><span class="line">        System.out.println(name);</span><br><span class="line">        System.out.println(studymodel);</span><br><span class="line">        System.out.println(description);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>QueryBuilders.termsQuery(“_id”,ids);还有termQuery方法，如果用这个方法会查不到</p>
</blockquote>
<h4 id="match-Query"><a href="#match-Query" class="headerlink" title="match Query"></a>match Query</h4><p>match Query即全文检索，它的搜索方式是先将搜索字符串分词，再使用各各词条从索引中搜索。<br>match query与Term query区别是match query在搜索前先将搜索关键字分词，再拿各各词语去索引中搜索。 </p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">POST xc_course/doc/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"query"</span>: &#123;</span><br><span class="line">        <span class="attr">"match"</span> : &#123;</span><br><span class="line">            <span class="attr">"description"</span> : &#123;</span><br><span class="line">                <span class="attr">"query"</span> : <span class="string">"spring开发"</span>,</span><br><span class="line">                <span class="attr">"operator"</span> : <span class="string">"or"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST xc_course/doc/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"query"</span>: &#123;</span><br><span class="line">        <span class="attr">"match"</span> : &#123;</span><br><span class="line">            <span class="attr">"description"</span> : &#123;</span><br><span class="line">                <span class="attr">"query"</span> : <span class="string">"spring开发框架"</span>,</span><br><span class="line">                <span class="attr">"minimum_should_match"</span>: <span class="string">"80%"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>query：这里会将spring和开发分开匹配</li>
<li>operator：or是分词后匹配一个即可。and是分词后都匹配<ul>
<li>minimum_should_match：百分之80的词匹配即可。然后向上取整。如3个词 3*0.8=2.4向上取整2    </li>
</ul>
</li>
</ul>
<h5 id="JAVA-API-4"><a href="#JAVA-API-4" class="headerlink" title="JAVA API"></a>JAVA API</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//MatchQuery</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testMatchQuery</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ParseException </span>&#123;</span><br><span class="line">    <span class="comment">//搜索请求对象</span></span><br><span class="line">    SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(<span class="string">"xc_course"</span>);</span><br><span class="line">    <span class="comment">//指定类型</span></span><br><span class="line">    searchRequest.types(<span class="string">"doc"</span>);</span><br><span class="line">    <span class="comment">//搜索源构建对象</span></span><br><span class="line">    SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//搜索方式</span></span><br><span class="line">    <span class="comment">//MatchQuery</span></span><br><span class="line">    searchSourceBuilder.query(QueryBuilders.matchQuery(<span class="string">"description"</span>,<span class="string">"spring开发框架"</span>)</span><br><span class="line">                              .minimumShouldMatch(<span class="string">"80%"</span>));</span><br><span class="line">    <span class="comment">//设置源字段过虑,第一个参数结果集包括哪些字段，第二个参数表示结果集不包括哪些字段</span></span><br><span class="line">    searchSourceBuilder.fetchSource(<span class="keyword">new</span> String[]&#123;<span class="string">"name"</span>,<span class="string">"studymodel"</span>,<span class="string">"price"</span>,<span class="string">"timestamp"</span>&#125;,<span class="keyword">new</span> String[]&#123;&#125;);</span><br><span class="line">    <span class="comment">//向搜索请求对象中设置搜索源</span></span><br><span class="line">    searchRequest.source(searchSourceBuilder);</span><br><span class="line">    <span class="comment">//执行搜索,向ES发起http请求</span></span><br><span class="line">    SearchResponse searchResponse = client.search(searchRequest);</span><br><span class="line">    <span class="comment">//搜索结果</span></span><br><span class="line">    SearchHits hits = searchResponse.getHits();</span><br><span class="line">    <span class="comment">//匹配到的总记录数</span></span><br><span class="line">    <span class="keyword">long</span> totalHits = hits.getTotalHits();</span><br><span class="line">    <span class="comment">//得到匹配度高的文档</span></span><br><span class="line">    SearchHit[] searchHits = hits.getHits();</span><br><span class="line">    <span class="comment">//日期格式化对象</span></span><br><span class="line">    SimpleDateFormat dateFormat = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>);</span><br><span class="line">    <span class="keyword">for</span>(SearchHit hit:searchHits)&#123;</span><br><span class="line">        <span class="comment">//文档的主键</span></span><br><span class="line">        String id = hit.getId();</span><br><span class="line">        <span class="comment">//源文档内容</span></span><br><span class="line">        Map&lt;String, Object&gt; sourceAsMap = hit.getSourceAsMap();</span><br><span class="line">        String name = (String) sourceAsMap.get(<span class="string">"name"</span>);</span><br><span class="line">        <span class="comment">//由于前边设置了源文档字段过虑，这时description是取不到的</span></span><br><span class="line">        String description = (String) sourceAsMap.get(<span class="string">"description"</span>);</span><br><span class="line">        <span class="comment">//学习模式</span></span><br><span class="line">        String studymodel = (String) sourceAsMap.get(<span class="string">"studymodel"</span>);</span><br><span class="line">        <span class="comment">//价格</span></span><br><span class="line">        Double price = (Double) sourceAsMap.get(<span class="string">"price"</span>);</span><br><span class="line">        <span class="comment">//日期</span></span><br><span class="line">        Date timestamp = dateFormat.parse((String) sourceAsMap.get(<span class="string">"timestamp"</span>));</span><br><span class="line">        System.out.println(name);</span><br><span class="line">        System.out.println(studymodel);</span><br><span class="line">        System.out.println(description);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//匹配关键字</span></span><br><span class="line">MatchQueryBuilder matchQueryBuilder = QueryBuilders.matchQuery(<span class="string">"description"</span>, <span class="string">"前台页面开发框架 架</span></span><br><span class="line"><span class="string">构"</span>)</span><br><span class="line">.minimumShouldMatch(<span class="string">"80%"</span>);<span class="comment">//设置匹配占比</span></span><br><span class="line">searchSourceBuilder.query(matchQueryBuilder);</span><br></pre></td></tr></table></figure>

<h4 id="multi-Query"><a href="#multi-Query" class="headerlink" title="multi Query"></a>multi Query</h4><p>上边学习的termQuery和matchQuery一次只能匹配一个Field，本节学习multiQuery，一次可以匹配多个字段。 </p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">POST xc_course/doc/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"query"</span>: &#123;</span><br><span class="line">        <span class="attr">"multi_match"</span> : &#123;</span><br><span class="line">            <span class="attr">"query"</span> : <span class="string">"spring css"</span>,</span><br><span class="line">            <span class="attr">"minimum_should_match"</span>: <span class="string">"50%"</span>,</span><br><span class="line">            <span class="attr">"fields"</span>: [ <span class="string">"name"</span>, <span class="string">"description"</span> ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>提升boost </p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">POST xc_course/doc/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"query"</span>: &#123;</span><br><span class="line">        <span class="attr">"multi_match"</span> : &#123;</span><br><span class="line">            <span class="attr">"query"</span> : <span class="string">"spring框架"</span>,</span><br><span class="line">            <span class="attr">"minimum_should_match"</span>: <span class="string">"50%"</span>,</span><br><span class="line">            <span class="attr">"fields"</span>: [ <span class="string">"name"</span>, <span class="string">"description"</span> ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">#将name的权重加大</span><br><span class="line">POST xc_course/doc/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"query"</span>: &#123;</span><br><span class="line">        <span class="attr">"multi_match"</span> : &#123;</span><br><span class="line">            <span class="attr">"query"</span> : <span class="string">"spring框架"</span>,</span><br><span class="line">            <span class="attr">"minimum_should_match"</span>: <span class="string">"50%"</span>,</span><br><span class="line">            <span class="attr">"fields"</span>: [ <span class="string">"name^10"</span>, <span class="string">"description"</span> ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="JAVA-API-5"><a href="#JAVA-API-5" class="headerlink" title="JAVA API"></a>JAVA API</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//MultiMatchQuery</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testMultiMatchQuery</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ParseException </span>&#123;</span><br><span class="line">    <span class="comment">//搜索请求对象</span></span><br><span class="line">    SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(<span class="string">"xc_course"</span>);</span><br><span class="line">    <span class="comment">//指定类型</span></span><br><span class="line">    searchRequest.types(<span class="string">"doc"</span>);</span><br><span class="line">    <span class="comment">//搜索源构建对象</span></span><br><span class="line">    SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//搜索方式</span></span><br><span class="line">    <span class="comment">//MultiMatchQuery</span></span><br><span class="line">    searchSourceBuilder.query(QueryBuilders.multiMatchQuery(<span class="string">"spring css"</span>,<span class="string">"name"</span>,<span class="string">"description"</span>)</span><br><span class="line">                              .minimumShouldMatch(<span class="string">"50%"</span>)</span><br><span class="line">                              .field(<span class="string">"name"</span>,<span class="number">10</span>));</span><br><span class="line">    <span class="comment">//设置源字段过虑,第一个参数结果集包括哪些字段，第二个参数表示结果集不包括哪些字段</span></span><br><span class="line">    searchSourceBuilder.fetchSource(<span class="keyword">new</span> String[]&#123;<span class="string">"name"</span>,<span class="string">"studymodel"</span>,<span class="string">"price"</span>,<span class="string">"timestamp"</span>&#125;,<span class="keyword">new</span> String[]&#123;&#125;);</span><br><span class="line">    <span class="comment">//向搜索请求对象中设置搜索源</span></span><br><span class="line">    searchRequest.source(searchSourceBuilder);</span><br><span class="line">    <span class="comment">//执行搜索,向ES发起http请求</span></span><br><span class="line">    SearchResponse searchResponse = client.search(searchRequest);</span><br><span class="line">    <span class="comment">//搜索结果</span></span><br><span class="line">    SearchHits hits = searchResponse.getHits();</span><br><span class="line">    <span class="comment">//匹配到的总记录数</span></span><br><span class="line">    <span class="keyword">long</span> totalHits = hits.getTotalHits();</span><br><span class="line">    <span class="comment">//得到匹配度高的文档</span></span><br><span class="line">    SearchHit[] searchHits = hits.getHits();</span><br><span class="line">    <span class="comment">//日期格式化对象</span></span><br><span class="line">    SimpleDateFormat dateFormat = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>);</span><br><span class="line">    <span class="keyword">for</span>(SearchHit hit:searchHits)&#123;</span><br><span class="line">        <span class="comment">//文档的主键</span></span><br><span class="line">        String id = hit.getId();</span><br><span class="line">        <span class="comment">//源文档内容</span></span><br><span class="line">        Map&lt;String, Object&gt; sourceAsMap = hit.getSourceAsMap();</span><br><span class="line">        String name = (String) sourceAsMap.get(<span class="string">"name"</span>);</span><br><span class="line">        <span class="comment">//由于前边设置了源文档字段过虑，这时description是取不到的</span></span><br><span class="line">        String description = (String) sourceAsMap.get(<span class="string">"description"</span>);</span><br><span class="line">        <span class="comment">//学习模式</span></span><br><span class="line">        String studymodel = (String) sourceAsMap.get(<span class="string">"studymodel"</span>);</span><br><span class="line">        <span class="comment">//价格</span></span><br><span class="line">        Double price = (Double) sourceAsMap.get(<span class="string">"price"</span>);</span><br><span class="line">        <span class="comment">//日期</span></span><br><span class="line">        Date timestamp = dateFormat.parse((String) sourceAsMap.get(<span class="string">"timestamp"</span>));</span><br><span class="line">        System.out.println(name);</span><br><span class="line">        System.out.println(studymodel);</span><br><span class="line">        System.out.println(description);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Bool-Query"><a href="#Bool-Query" class="headerlink" title="Bool Query"></a>Bool Query</h4><p>布尔查询对应于Lucene的BooleanQuery查询，实现将多个查询组合起来 </p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">POST xc_course/doc/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"_source"</span> : [ <span class="string">"name"</span>, <span class="string">"studymodel"</span>, <span class="string">"description"</span>],</span><br><span class="line">    <span class="attr">"from"</span> : <span class="number">0</span>, <span class="attr">"size"</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"query"</span>: &#123;</span><br><span class="line">        <span class="attr">"bool"</span> : &#123;</span><br><span class="line">            <span class="attr">"must"</span>:[</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"multi_match"</span> : &#123;</span><br><span class="line">                        <span class="attr">"query"</span> : <span class="string">"spring框架"</span>,</span><br><span class="line">                        <span class="attr">"minimum_should_match"</span>: <span class="string">"50%"</span>,</span><br><span class="line">                        <span class="attr">"fields"</span>: [ <span class="string">"name^10"</span>, <span class="string">"description"</span> ]</span><br><span class="line">                    &#125; &#125;</span><br><span class="line">                ,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"term"</span>:&#123;</span><br><span class="line">                        <span class="attr">"studymodel"</span> : <span class="string">"201001"</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>must：表示必须，多个查询条件必须都满足。（通常使用must）</li>
<li>should：表示或者，多个查询条件只要有一个满足即可。</li>
<li>must_not：表示非。 不满足也行</li>
</ul>
<h5 id="JAVA-API-6"><a href="#JAVA-API-6" class="headerlink" title="JAVA API"></a>JAVA API</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//BoolQuery</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testBoolQuery</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ParseException </span>&#123;</span><br><span class="line">    <span class="comment">//搜索请求对象</span></span><br><span class="line">    SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(<span class="string">"xc_course"</span>);</span><br><span class="line">    <span class="comment">//指定类型</span></span><br><span class="line">    searchRequest.types(<span class="string">"doc"</span>);</span><br><span class="line">    <span class="comment">//搜索源构建对象</span></span><br><span class="line">    SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">    <span class="comment">//boolQuery搜索方式</span></span><br><span class="line">    <span class="comment">//先定义一个MultiMatchQuery</span></span><br><span class="line">    MultiMatchQueryBuilder multiMatchQueryBuilder = QueryBuilders.multiMatchQuery(<span class="string">"spring css"</span>, <span class="string">"name"</span>, <span class="string">"description"</span>)</span><br><span class="line">        .minimumShouldMatch(<span class="string">"50%"</span>)</span><br><span class="line">        .field(<span class="string">"name"</span>, <span class="number">10</span>);</span><br><span class="line">    <span class="comment">//再定义一个termQuery</span></span><br><span class="line">    TermQueryBuilder termQueryBuilder = QueryBuilders.termQuery(<span class="string">"studymodel"</span>, <span class="string">"201001"</span>);</span><br><span class="line">    <span class="comment">//定义一个boolQuery</span></span><br><span class="line">    BoolQueryBuilder boolQueryBuilder = QueryBuilders.boolQuery();</span><br><span class="line">    boolQueryBuilder.must(multiMatchQueryBuilder);</span><br><span class="line">    boolQueryBuilder.must(termQueryBuilder);</span><br><span class="line">    searchSourceBuilder.query(boolQueryBuilder);</span><br><span class="line">    <span class="comment">//设置源字段过虑,第一个参数结果集包括哪些字段，第二个参数表示结果集不包括哪些字段</span></span><br><span class="line">    searchSourceBuilder.fetchSource(<span class="keyword">new</span> String[]&#123;<span class="string">"name"</span>,<span class="string">"studymodel"</span>,<span class="string">"price"</span>,<span class="string">"timestamp"</span>&#125;,<span class="keyword">new</span> String[]&#123;&#125;);</span><br><span class="line">    <span class="comment">//向搜索请求对象中设置搜索源</span></span><br><span class="line">    searchRequest.source(searchSourceBuilder);</span><br><span class="line">    <span class="comment">//执行搜索,向ES发起http请求</span></span><br><span class="line">    SearchResponse searchResponse = client.search(searchRequest);</span><br><span class="line">    <span class="comment">//搜索结果</span></span><br><span class="line">    SearchHits hits = searchResponse.getHits();</span><br><span class="line">    <span class="comment">//匹配到的总记录数</span></span><br><span class="line">    <span class="keyword">long</span> totalHits = hits.getTotalHits();</span><br><span class="line">    <span class="comment">//得到匹配度高的文档</span></span><br><span class="line">    SearchHit[] searchHits = hits.getHits();</span><br><span class="line">    <span class="comment">//日期格式化对象</span></span><br><span class="line">    SimpleDateFormat dateFormat = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>);</span><br><span class="line">    <span class="keyword">for</span>(SearchHit hit:searchHits)&#123;</span><br><span class="line">        <span class="comment">//文档的主键</span></span><br><span class="line">        String id = hit.getId();</span><br><span class="line">        <span class="comment">//源文档内容</span></span><br><span class="line">        Map&lt;String, Object&gt; sourceAsMap = hit.getSourceAsMap();</span><br><span class="line">        String name = (String) sourceAsMap.get(<span class="string">"name"</span>);</span><br><span class="line">        <span class="comment">//由于前边设置了源文档字段过虑，这时description是取不到的</span></span><br><span class="line">        String description = (String) sourceAsMap.get(<span class="string">"description"</span>);</span><br><span class="line">        <span class="comment">//学习模式</span></span><br><span class="line">        String studymodel = (String) sourceAsMap.get(<span class="string">"studymodel"</span>);</span><br><span class="line">        <span class="comment">//价格</span></span><br><span class="line">        Double price = (Double) sourceAsMap.get(<span class="string">"price"</span>);</span><br><span class="line">        <span class="comment">//日期</span></span><br><span class="line">        Date timestamp = dateFormat.parse((String) sourceAsMap.get(<span class="string">"timestamp"</span>));</span><br><span class="line">        System.out.println(name);</span><br><span class="line">        System.out.println(studymodel);</span><br><span class="line">        System.out.println(description);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="过虑器"><a href="#过虑器" class="headerlink" title="过虑器"></a>过虑器</h4><p>过虑是针对搜索的结果进行过虑，过虑器主要判断的是文档是否匹配，不去计算和判断文档的匹配度得分，所以过<br>虑器性能比查询要高，且方便缓存，推荐尽量使用过虑器去实现查询或者过虑器和查询共同使用。 </p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">POST xc_course/doc/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"_source"</span> : [ <span class="string">"name"</span>, <span class="string">"studymodel"</span>, <span class="string">"description"</span>,<span class="string">"price"</span>],</span><br><span class="line">    <span class="attr">"query"</span>: &#123;</span><br><span class="line">        <span class="attr">"bool"</span> : &#123;</span><br><span class="line">            <span class="attr">"must"</span>:[</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"multi_match"</span> : &#123;</span><br><span class="line">                        <span class="attr">"query"</span> : <span class="string">"spring框架"</span>,</span><br><span class="line">                        <span class="attr">"minimum_should_match"</span>: <span class="string">"50%"</span>,</span><br><span class="line">                        <span class="attr">"fields"</span>: [ <span class="string">"name^10"</span>, <span class="string">"description"</span> ]</span><br><span class="line">                    &#125; &#125;</span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">"filter"</span>: [</span><br><span class="line">                &#123; <span class="attr">"term"</span>: &#123; <span class="attr">"studymodel"</span>: <span class="string">"201001"</span> &#125;&#125;,</span><br><span class="line">                &#123; <span class="attr">"range"</span>: &#123; <span class="attr">"price"</span>: &#123; <span class="attr">"gte"</span>: <span class="number">60</span> ,<span class="attr">"lte"</span> : <span class="number">100</span>&#125;&#125;&#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>range：范围过虑，保留大于等于60 并且小于等于100的记录。 </li>
<li>term：项匹配过虑，保留studymodel等于”201001”的记录。 </li>
</ul>
<blockquote>
<p>range和term一次只能对一个Field设置范围过虑。 </p>
</blockquote>
<h5 id="JAVA-API-7"><a href="#JAVA-API-7" class="headerlink" title="JAVA API"></a>JAVA API</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//filter</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testFilter</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ParseException </span>&#123;</span><br><span class="line">    <span class="comment">//搜索请求对象</span></span><br><span class="line">    SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(<span class="string">"xc_course"</span>);</span><br><span class="line">    <span class="comment">//指定类型</span></span><br><span class="line">    searchRequest.types(<span class="string">"doc"</span>);</span><br><span class="line">    <span class="comment">//搜索源构建对象</span></span><br><span class="line">    SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">    <span class="comment">//boolQuery搜索方式</span></span><br><span class="line">    <span class="comment">//先定义一个MultiMatchQuery</span></span><br><span class="line">    MultiMatchQueryBuilder multiMatchQueryBuilder = QueryBuilders.multiMatchQuery(<span class="string">"spring css"</span>, <span class="string">"name"</span>, <span class="string">"description"</span>)</span><br><span class="line">        .minimumShouldMatch(<span class="string">"50%"</span>)</span><br><span class="line">        .field(<span class="string">"name"</span>, <span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//定义一个boolQuery</span></span><br><span class="line">    BoolQueryBuilder boolQueryBuilder = QueryBuilders.boolQuery();</span><br><span class="line">    boolQueryBuilder.must(multiMatchQueryBuilder);</span><br><span class="line">    <span class="comment">//定义过虑器</span></span><br><span class="line">    boolQueryBuilder.filter(QueryBuilders.termQuery(<span class="string">"studymodel"</span>,<span class="string">"201001"</span>));</span><br><span class="line">    boolQueryBuilder.filter(QueryBuilders.rangeQuery(<span class="string">"price"</span>).gte(<span class="number">90</span>).lte(<span class="number">100</span>));</span><br><span class="line">    searchSourceBuilder.query(boolQueryBuilder);</span><br><span class="line">    <span class="comment">//设置源字段过虑,第一个参数结果集包括哪些字段，第二个参数表示结果集不包括哪些字段</span></span><br><span class="line">    searchSourceBuilder.fetchSource(<span class="keyword">new</span> String[]&#123;<span class="string">"name"</span>,<span class="string">"studymodel"</span>,<span class="string">"price"</span>,<span class="string">"timestamp"</span>&#125;,<span class="keyword">new</span> String[]&#123;&#125;);</span><br><span class="line">    <span class="comment">//向搜索请求对象中设置搜索源</span></span><br><span class="line">    searchRequest.source(searchSourceBuilder);</span><br><span class="line">    <span class="comment">//执行搜索,向ES发起http请求</span></span><br><span class="line">    SearchResponse searchResponse = client.search(searchRequest);</span><br><span class="line">    <span class="comment">//搜索结果</span></span><br><span class="line">    SearchHits hits = searchResponse.getHits();</span><br><span class="line">    <span class="comment">//匹配到的总记录数</span></span><br><span class="line">    <span class="keyword">long</span> totalHits = hits.getTotalHits();</span><br><span class="line">    <span class="comment">//得到匹配度高的文档</span></span><br><span class="line">    SearchHit[] searchHits = hits.getHits();</span><br><span class="line">    <span class="comment">//日期格式化对象</span></span><br><span class="line">    SimpleDateFormat dateFormat = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>);</span><br><span class="line">    <span class="keyword">for</span>(SearchHit hit:searchHits)&#123;</span><br><span class="line">        <span class="comment">//文档的主键</span></span><br><span class="line">        String id = hit.getId();</span><br><span class="line">        <span class="comment">//源文档内容</span></span><br><span class="line">        Map&lt;String, Object&gt; sourceAsMap = hit.getSourceAsMap();</span><br><span class="line">        String name = (String) sourceAsMap.get(<span class="string">"name"</span>);</span><br><span class="line">        <span class="comment">//由于前边设置了源文档字段过虑，这时description是取不到的</span></span><br><span class="line">        String description = (String) sourceAsMap.get(<span class="string">"description"</span>);</span><br><span class="line">        <span class="comment">//学习模式</span></span><br><span class="line">        String studymodel = (String) sourceAsMap.get(<span class="string">"studymodel"</span>);</span><br><span class="line">        <span class="comment">//价格</span></span><br><span class="line">        Double price = (Double) sourceAsMap.get(<span class="string">"price"</span>);</span><br><span class="line">        <span class="comment">//日期</span></span><br><span class="line">        Date timestamp = dateFormat.parse((String) sourceAsMap.get(<span class="string">"timestamp"</span>));</span><br><span class="line">        System.out.println(name);</span><br><span class="line">        System.out.println(studymodel);</span><br><span class="line">        System.out.println(description);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h4><p>可以在字段上添加一个或多个排序，支持在keyword、date、float等类型上添加，text类型的字段上不允许添加排<br>序。 </p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">POST xc_course/doc/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"_source"</span> : [ <span class="string">"name"</span>, <span class="string">"studymodel"</span>, <span class="string">"description"</span>,<span class="string">"price"</span>],</span><br><span class="line">    <span class="attr">"query"</span>: &#123;</span><br><span class="line">        <span class="attr">"bool"</span> : &#123;</span><br><span class="line">            <span class="attr">"filter"</span>: [</span><br><span class="line">                &#123; <span class="attr">"range"</span>: &#123; <span class="attr">"price"</span>: &#123; <span class="attr">"gte"</span>: <span class="number">0</span> ,<span class="attr">"lte"</span> : <span class="number">100</span>&#125;&#125;&#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"sort"</span> : [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"studymodel"</span> : <span class="string">"desc"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"price"</span> : <span class="string">"asc"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>过虑0–10元价格范围的文档，并且对结果进行排序，先按studymodel降序，再按价格升序 </p>
<h5 id="JAVA-API-8"><a href="#JAVA-API-8" class="headerlink" title="JAVA API"></a>JAVA API</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Sort</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSort</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ParseException </span>&#123;</span><br><span class="line">    <span class="comment">//搜索请求对象</span></span><br><span class="line">    SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(<span class="string">"xc_course"</span>);</span><br><span class="line">    <span class="comment">//指定类型</span></span><br><span class="line">    searchRequest.types(<span class="string">"doc"</span>);</span><br><span class="line">    <span class="comment">//搜索源构建对象</span></span><br><span class="line">    SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">    <span class="comment">//boolQuery搜索方式</span></span><br><span class="line">    <span class="comment">//定义一个boolQuery</span></span><br><span class="line">    BoolQueryBuilder boolQueryBuilder = QueryBuilders.boolQuery();</span><br><span class="line">    <span class="comment">//定义过虑器</span></span><br><span class="line">    boolQueryBuilder.filter(QueryBuilders.rangeQuery(<span class="string">"price"</span>).gte(<span class="number">0</span>).lte(<span class="number">100</span>));</span><br><span class="line">    searchSourceBuilder.query(boolQueryBuilder);</span><br><span class="line">    <span class="comment">//添加排序</span></span><br><span class="line">    searchSourceBuilder.sort(<span class="string">"studymodel"</span>, SortOrder.DESC);</span><br><span class="line">    searchSourceBuilder.sort(<span class="string">"price"</span>, SortOrder.ASC);</span><br><span class="line">    <span class="comment">//设置源字段过虑,第一个参数结果集包括哪些字段，第二个参数表示结果集不包括哪些字段</span></span><br><span class="line">    searchSourceBuilder.fetchSource(<span class="keyword">new</span> String[]&#123;<span class="string">"name"</span>,<span class="string">"studymodel"</span>,<span class="string">"price"</span>,<span class="string">"timestamp"</span>&#125;,<span class="keyword">new</span> String[]&#123;&#125;);</span><br><span class="line">    <span class="comment">//向搜索请求对象中设置搜索源</span></span><br><span class="line">    searchRequest.source(searchSourceBuilder);</span><br><span class="line">    <span class="comment">//执行搜索,向ES发起http请求</span></span><br><span class="line">    SearchResponse searchResponse = client.search(searchRequest);</span><br><span class="line">    <span class="comment">//搜索结果</span></span><br><span class="line">    SearchHits hits = searchResponse.getHits();</span><br><span class="line">    <span class="comment">//匹配到的总记录数</span></span><br><span class="line">    <span class="keyword">long</span> totalHits = hits.getTotalHits();</span><br><span class="line">    <span class="comment">//得到匹配度高的文档</span></span><br><span class="line">    SearchHit[] searchHits = hits.getHits();</span><br><span class="line">    <span class="comment">//日期格式化对象</span></span><br><span class="line">    SimpleDateFormat dateFormat = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>);</span><br><span class="line">    <span class="keyword">for</span>(SearchHit hit:searchHits)&#123;</span><br><span class="line">        <span class="comment">//文档的主键</span></span><br><span class="line">        String id = hit.getId();</span><br><span class="line">        <span class="comment">//源文档内容</span></span><br><span class="line">        Map&lt;String, Object&gt; sourceAsMap = hit.getSourceAsMap();</span><br><span class="line">        String name = (String) sourceAsMap.get(<span class="string">"name"</span>);</span><br><span class="line">        <span class="comment">//由于前边设置了源文档字段过虑，这时description是取不到的</span></span><br><span class="line">        String description = (String) sourceAsMap.get(<span class="string">"description"</span>);</span><br><span class="line">        <span class="comment">//学习模式</span></span><br><span class="line">        String studymodel = (String) sourceAsMap.get(<span class="string">"studymodel"</span>);</span><br><span class="line">        <span class="comment">//价格</span></span><br><span class="line">        Double price = (Double) sourceAsMap.get(<span class="string">"price"</span>);</span><br><span class="line">        <span class="comment">//日期</span></span><br><span class="line">        Date timestamp = dateFormat.parse((String) sourceAsMap.get(<span class="string">"timestamp"</span>));</span><br><span class="line">        System.out.println(name);</span><br><span class="line">        System.out.println(studymodel);</span><br><span class="line">        System.out.println(description);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="高亮"><a href="#高亮" class="headerlink" title="高亮"></a>高亮</h4><p>给匹配到的地方添加指定标签</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">POST xc_course/doc/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"_source"</span> : [ <span class="string">"name"</span>, <span class="string">"studymodel"</span>, <span class="string">"description"</span>,<span class="string">"price"</span>],</span><br><span class="line">    <span class="attr">"query"</span>: &#123;</span><br><span class="line">        <span class="attr">"bool"</span> : &#123;</span><br><span class="line">            <span class="attr">"must"</span>:[</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"multi_match"</span> : &#123;</span><br><span class="line">                        <span class="attr">"query"</span> : <span class="string">"开发框架"</span>,</span><br><span class="line">                        <span class="attr">"minimum_should_match"</span>: <span class="string">"50%"</span>,</span><br><span class="line">                        <span class="attr">"fields"</span>: [ <span class="string">"name^10"</span>, <span class="string">"description"</span> ],</span><br><span class="line">                        <span class="attr">"type"</span>:<span class="string">"best_fields"</span></span><br><span class="line">                    &#125; &#125;</span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">"filter"</span>: [</span><br><span class="line">                &#123; <span class="attr">"range"</span>: &#123; <span class="attr">"price"</span>: &#123; <span class="attr">"gte"</span>: <span class="number">0</span> ,<span class="attr">"lte"</span> : <span class="number">100</span>&#125;&#125;&#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"sort"</span> : [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"price"</span> : <span class="string">"asc"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"highlight"</span>: &#123;</span><br><span class="line">        <span class="attr">"pre_tags"</span>: [<span class="string">"&lt;tag1&gt;"</span>],</span><br><span class="line">        <span class="attr">"post_tags"</span>: [<span class="string">"&lt;/tag2&gt;"</span>],</span><br><span class="line">        <span class="attr">"fields"</span>: &#123;</span><br><span class="line">            <span class="attr">"name"</span>: &#123;&#125;,</span><br><span class="line">            <span class="attr">"description"</span>:&#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>pre_tags</li>
</ul>
<h5 id="JAVA-API-9"><a href="#JAVA-API-9" class="headerlink" title="JAVA API"></a>JAVA API</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Highlight</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testHighlight</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ParseException </span>&#123;</span><br><span class="line">    <span class="comment">//搜索请求对象</span></span><br><span class="line">    SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(<span class="string">"xc_course"</span>);</span><br><span class="line">    <span class="comment">//指定类型</span></span><br><span class="line">    searchRequest.types(<span class="string">"doc"</span>);</span><br><span class="line">    <span class="comment">//搜索源构建对象</span></span><br><span class="line">    SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">    <span class="comment">//boolQuery搜索方式</span></span><br><span class="line">    <span class="comment">//先定义一个MultiMatchQuery</span></span><br><span class="line">    MultiMatchQueryBuilder multiMatchQueryBuilder = QueryBuilders.multiMatchQuery(<span class="string">"开发框架"</span>, <span class="string">"name"</span>, <span class="string">"description"</span>)</span><br><span class="line">        .minimumShouldMatch(<span class="string">"50%"</span>)</span><br><span class="line">        .field(<span class="string">"name"</span>, <span class="number">10</span>);</span><br><span class="line">    <span class="comment">//定义一个boolQuery</span></span><br><span class="line">    BoolQueryBuilder boolQueryBuilder = QueryBuilders.boolQuery();</span><br><span class="line">    boolQueryBuilder.must(multiMatchQueryBuilder);</span><br><span class="line">    <span class="comment">//定义过虑器</span></span><br><span class="line">    boolQueryBuilder.filter(QueryBuilders.rangeQuery(<span class="string">"price"</span>).gte(<span class="number">0</span>).lte(<span class="number">100</span>));</span><br><span class="line">    searchSourceBuilder.query(boolQueryBuilder);</span><br><span class="line">    <span class="comment">//设置源字段过虑,第一个参数结果集包括哪些字段，第二个参数表示结果集不包括哪些字段</span></span><br><span class="line">    searchSourceBuilder.fetchSource(<span class="keyword">new</span> String[]&#123;<span class="string">"name"</span>, <span class="string">"studymodel"</span>, <span class="string">"price"</span>, <span class="string">"timestamp"</span>&#125;, <span class="keyword">new</span> String[]&#123;&#125;);</span><br><span class="line">    <span class="comment">//设置高亮</span></span><br><span class="line">    HighlightBuilder highlightBuilder = <span class="keyword">new</span> HighlightBuilder();</span><br><span class="line">    highlightBuilder.preTags(<span class="string">"&lt;tag&gt;"</span>);</span><br><span class="line">    highlightBuilder.postTags(<span class="string">"&lt;/tag&gt;"</span>);</span><br><span class="line">    highlightBuilder.fields().add(<span class="keyword">new</span> HighlightBuilder.Field(<span class="string">"name"</span>));</span><br><span class="line">    <span class="comment">//再添加一个高亮字段</span></span><br><span class="line">    <span class="comment">//highlightBuilder.fields().add(new HighlightBuilder.Field("description"));</span></span><br><span class="line">    searchSourceBuilder.highlighter(highlightBuilder);</span><br><span class="line">    <span class="comment">//向搜索请求对象中设置搜索源</span></span><br><span class="line">    searchRequest.source(searchSourceBuilder);</span><br><span class="line">    <span class="comment">//执行搜索,向ES发起http请求</span></span><br><span class="line">    SearchResponse searchResponse = client.search(searchRequest);</span><br><span class="line">    <span class="comment">//搜索结果</span></span><br><span class="line">    SearchHits hits = searchResponse.getHits();</span><br><span class="line">    <span class="comment">//匹配到的总记录数</span></span><br><span class="line">    <span class="keyword">long</span> totalHits = hits.getTotalHits();</span><br><span class="line">    <span class="comment">//得到匹配度高的文档</span></span><br><span class="line">    SearchHit[] searchHits = hits.getHits();</span><br><span class="line">    <span class="comment">//日期格式化对象</span></span><br><span class="line">    SimpleDateFormat dateFormat = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>);</span><br><span class="line">    <span class="keyword">for</span> (SearchHit hit : searchHits) &#123;</span><br><span class="line">        <span class="comment">//文档的主键</span></span><br><span class="line">        String id = hit.getId();</span><br><span class="line">        <span class="comment">//源文档内容</span></span><br><span class="line">        Map&lt;String, Object&gt; sourceAsMap = hit.getSourceAsMap();</span><br><span class="line">        <span class="comment">//源文档的name字段内容</span></span><br><span class="line">        String name = (String) sourceAsMap.get(<span class="string">"name"</span>);</span><br><span class="line">        <span class="comment">//取出高亮字段</span></span><br><span class="line">        Map&lt;String, HighlightField&gt; highlightFields = hit.getHighlightFields();</span><br><span class="line">        <span class="keyword">if</span> (highlightFields != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//取出name高亮字段</span></span><br><span class="line">            HighlightField nameHighlightField = highlightFields.get(<span class="string">"name"</span>);</span><br><span class="line">            <span class="keyword">if</span> (nameHighlightField != <span class="keyword">null</span>) &#123;</span><br><span class="line">                Text[] fragments = nameHighlightField.getFragments();</span><br><span class="line">                StringBuffer stringBuffer = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">                <span class="keyword">for</span> (Text text : fragments) &#123;</span><br><span class="line">                    stringBuffer.append(text);</span><br><span class="line">                &#125;</span><br><span class="line">                name = stringBuffer.toString();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//由于前边设置了源文档字段过虑，这时description是取不到的</span></span><br><span class="line">        String description = (String) sourceAsMap.get(<span class="string">"description"</span>);</span><br><span class="line">        <span class="comment">//学习模式</span></span><br><span class="line">        String studymodel = (String) sourceAsMap.get(<span class="string">"studymodel"</span>);</span><br><span class="line">        <span class="comment">//价格</span></span><br><span class="line">        Double price = (Double) sourceAsMap.get(<span class="string">"price"</span>);</span><br><span class="line">        <span class="comment">//日期</span></span><br><span class="line">        Date timestamp = dateFormat.parse((String) sourceAsMap.get(<span class="string">"timestamp"</span>));</span><br><span class="line">        System.out.println(name);</span><br><span class="line">        System.out.println(studymodel);</span><br><span class="line">        System.out.println(description);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="aggs聚合"><a href="#aggs聚合" class="headerlink" title="aggs聚合"></a>aggs聚合</h4><p>环境改变了。下列代码不复用上述环境</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 按照total_amount求平均值</span><br><span class="line">POST order_infor/_doc/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"aggs"</span>:&#123;</span><br><span class="line">    <span class="attr">"Name"</span>:&#123;</span><br><span class="line">      <span class="attr">"avg"</span>:&#123;</span><br><span class="line">        <span class="attr">"field"</span>:<span class="string">"total_amount"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#AAA中包含BBB的，根据name分类降序聚合出前10位</span><br><span class="line">GET …/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"query"</span>: &#123;</span><br><span class="line">        <span class="attr">"match"</span> : &#123;</span><br><span class="line">            <span class="attr">"AAA"</span>: <span class="string">"BBB"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"aggs"</span>:&#123;</span><br><span class="line">        <span class="attr">"Name"</span>:&#123;</span><br><span class="line">            <span class="attr">"terms"</span>:&#123;</span><br><span class="line">               <span class="attr">"field"</span>:<span class="string">"name"</span>,</span><br><span class="line">                <span class="attr">"size"</span>: <span class="number">10</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>在聚合的时候test字段可能会报错，这时要设置字段属性</p>
<p>PUT 索引库名/_mapping/类型名<br>{<br>  “properties”: {<br>    “参数名”: {<br>      “type”:     “text”,<br>      “fielddata”: true<br>    }<br>  }<br>}</p>
<p>如果设置报错，可以删除索引库，再创建，在创建映射的时候，在字段的属性内加入”fielddata”: true</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#聚合内部还可以再聚合</span><br><span class="line">GET 索引名/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"aggs"</span>:&#123;</span><br><span class="line">        <span class="attr">"name1"</span>:&#123;</span><br><span class="line">            <span class="attr">"terms"</span>:&#123;</span><br><span class="line">                <span class="attr">"field"</span>: <span class="string">"field1"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"aggs"</span>:&#123;</span><br><span class="line">          <span class="attr">"name2"</span>:&#123;</span><br><span class="line">            <span class="attr">"terms"</span>:&#123;</span><br><span class="line">              <span class="attr">"field"</span>: <span class="string">"field2"</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</div><div class="tags"><a href="/tags/nosql/"><i class="fa fa-tag"></i>nosql</a><a href="/tags/elasticsearch/"><i class="fa fa-tag"></i>elasticsearch</a></div><div class="post-nav"><a class="pre" href="/2019/11/26/Flink%E7%AC%94%E8%AE%B0/">Flink笔记</a><a class="next" href="/2019/11/09/nginx%E7%AC%94%E8%AE%B0/">nginx笔记</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://example.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/Scala/" style="font-size: 15px;">Scala</a> <a href="/tags/%E5%B9%B6%E5%8F%91/" style="font-size: 15px;">并发</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/nosql/" style="font-size: 15px;">nosql</a> <a href="/tags/elasticsearch/" style="font-size: 15px;">elasticsearch</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/PHP/" style="font-size: 15px;">PHP</a> <a href="/tags/%E5%90%8E%E7%AB%AF/" style="font-size: 15px;">后端</a> <a href="/tags/redis/" style="font-size: 15px;">redis</a> <a href="/tags/scala/" style="font-size: 15px;">scala</a> <a href="/tags/Shell/" style="font-size: 15px;">Shell</a> <a href="/tags/Spark/" style="font-size: 15px;">Spark</a> <a href="/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/" style="font-size: 15px;">大数据</a> <a href="/tags/SQL/" style="font-size: 15px;">SQL</a> <a href="/tags/java/" style="font-size: 15px;">java</a> <a href="/tags/springsecurity/" style="font-size: 15px;">springsecurity</a> <a href="/tags/php/" style="font-size: 15px;">php</a> <a href="/tags/wordpress/" style="font-size: 15px;">wordpress</a> <a href="/tags/C/" style="font-size: 15px;">C++</a> <a href="/tags/mysql/" style="font-size: 15px;">mysql</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/marjora/" style="font-size: 15px;">marjora</a> <a href="/tags/virtualbox/" style="font-size: 15px;">virtualbox</a> <a href="/tags/maven/" style="font-size: 15px;">maven</a> <a href="/tags/bug/" style="font-size: 15px;">bug</a> <a href="/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8/" style="font-size: 15px;">服务器</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 15px;">算法</a> <a href="/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/" style="font-size: 15px;">机器学习</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/%E5%8D%9A%E5%AE%A2/" style="font-size: 15px;">博客</a> <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/" style="font-size: 15px;">计算机基础</a> <a href="/tags/%E7%88%AC%E8%99%AB/" style="font-size: 15px;">爬虫</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 15px;">设计模式</a> <a href="/tags/%E6%B5%81%E7%A8%8B/" style="font-size: 15px;">流程</a> <a href="/tags/%E5%BC%80%E5%8F%91/" style="font-size: 15px;">开发</a> <a href="/tags/Flink/" style="font-size: 15px;">Flink</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/JVM/" style="font-size: 15px;">JVM</a> <a href="/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" style="font-size: 15px;">并发编程</a> <a href="/tags/spring/" style="font-size: 15px;">spring</a> <a href="/tags/%E5%89%8D%E7%AB%AF/" style="font-size: 15px;">前端</a> <a href="/tags/Vue/" style="font-size: 15px;">Vue</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size: 15px;">数据结构</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2021/07/06/Redis/">Redis</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/05/24/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/">Git笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/05/07/JVM/">JVM</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/04/27/%E7%88%AC%E8%99%AB/">爬虫</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/09/26/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/">机器学习</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/09/25/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86/">计算机组成原理</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/09/25/Git%E7%AC%94%E8%AE%B0/">Git笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/09/25/manjaro%E9%85%8D%E7%BD%AE%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/">manjaro配置开发环境</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/09/25/docker%E7%AC%94%E8%AE%B0/">docker笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/06/13/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">操作系统</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Links</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2021 <a href="/." rel="nofollow">dian的博客.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js" successtext="Copy Successed!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>